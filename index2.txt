<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∞</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --success: #22c55e; --danger: #ef4444; --bg: #f8fafc; --dark: #1e293b; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); padding: 15px; margin: 0; color: var(--dark); }
        .container { max-width: 1100px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 25px; border: 1px solid #edf2f7; }
        .account-manager { display: flex; flex-direction: column; gap: 12px; max-width: 500px; margin-bottom: 10px; }
        .btn-add-acc { background: var(--dark); color: white; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .input-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-top: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 14px; font-weight: 600; color: #64748b; }
        input, select { width: 100%; padding: 14px; border-radius: 12px; border: 1.5px solid #e2e8f0; font-size: 16px; outline: none; box-sizing: border-box; }
        .btn-save { grid-column: 1 / -1; background: var(--primary); color: white; padding: 16px; border-radius: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .acc-grid { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; }
        .acc-card { min-width: 180px; background: linear-gradient(135deg, #6366f1, #4338ca); color: white; padding: 20px; border-radius: 18px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 850px; }
        td { background: white; padding: 15px; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
        td:first-child { border-radius: 12px 0 0 12px; border-left: 1px solid #f1f5f9; }
        td:last-child { border-radius: 0 12px 12px 0; border-right: 1px solid #f1f5f9; }
        .badge { background: #f1f5f9; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
        .txt-‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö { color: var(--success); font-weight: bold; }
        .txt-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ { color: var(--danger); font-weight: bold; }
        .import-box { margin-bottom: 15px; padding: 15px; background: #f0f4ff; border-radius: 12px; border: 1px dashed var(--primary); }
        #lightbox { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; }
        #lightbox img { max-width: 90%; max-height: 90%; border-radius: 10px; }
    </style>
</head>
<body>

<div id="lightbox" onclick="this.style.display='none'"><img id="lightImg"></div>

<div class="container">
    <h2 style="text-align: center; color: var(--primary); margin: 25px 0;">üí∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∞</h2>

    <div class="card">
        <h3>üè¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h3>
        <div class="account-manager">
            <div class="form-group">
                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                <input type="text" id="newAcc" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£ üè¶">
            </div>
            <button class="btn-add-acc" onclick="addAccount()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div id="accBadges" style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 15px;"></div>
    </div>

    <div id="accCards" class="acc-grid"></div>

    <div class="card">
        <h3>üìù ‡∏•‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
        <div class="input-form">
            <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="date"></div>
            <div class="form-group"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><select id="accSelect"></select></div>
            <div class="form-group">
                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                <select id="type">
                    <option value="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
                    <option value="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" selected>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
                </select>
            </div>
            <div class="form-group"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="desc" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üç±"></div>
            <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="amt" placeholder="0.00"></div>
            <div class="form-group"><label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</label><input type="file" id="slipInput" accept="image/*"></div>
            <button class="btn-save" onclick="saveData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î üí∞</button>
        </div>
    </div>

    <div class="card" style="overflow-x: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <div class="form-group">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</label>
                <input type="month" id="filterMonth" onchange="updateUI()" style="width: auto;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="exportExcelFull()" style="background:#059669; color:white; padding:12px 20px; border-radius:12px; font-weight:bold; border:none; cursor:pointer;">üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
            </div>
        </div>

        <div class="import-box">
            <label style="font-weight: bold; color: var(--primary);">üìÇ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡∏à‡∏î‡∏ï‡πà‡∏≠:</label>
            <input type="file" id="importExcel" accept=".xlsx" onchange="importFromExcel(this)" style="margin-top: 5px;">
        </div>

        <table>
            <thead>
                <tr>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th>‡∏™‡∏•‡∏¥‡∏õ</th>
                    <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="dataTable"></tbody>
        </table>
    </div>
</div>

<script>
    let accounts = JSON.parse(localStorage.getItem('FIN_V4_ACCS')) || ['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ', '‡∏Å‡∏™‡∏¥‡∏Å‡∏£ üè¶'];
    let logs = JSON.parse(localStorage.getItem('FIN_V4_LOGS')) || [];

    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2) ---
    function importFromExcel(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            let newLogs = [];
            workbook.SheetNames.forEach(sheetName => {
                const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {range: 5});
                sheetData.forEach(row => {
                    if(row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"]) {
                        newLogs.push({
                            id: Date.now() + Math.random(),
                            date: row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"],
                            acc: sheetName,
                            type: row["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"],
                            desc: row["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"],
                            amt: parseFloat(row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"]) || 0,
                            slip: ""
                        });
                    }
                });
            });
            if(newLogs.length > 0) {
                if(confirm(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ${newLogs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    logs = [...logs, ...newLogs];
                    saveAndUI();
                    alert("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                }
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function addAccount() {
        let name = document.getElementById('newAcc').value.trim();
        if(name && !accounts.includes(name)) { accounts.push(name); document.getElementById('newAcc').value = ''; saveAndUI(); }
    }

    function removeAccount(name) {
        if(confirm(`‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${name}?`)) { accounts = accounts.filter(a => a !== name); saveAndUI(); }
    }

    function saveData() {
        let amt = parseFloat(document.getElementById('amt').value) || 0;
        let file = document.getElementById('slipInput').files[0];
        if(amt <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
        if (file) {
            let reader = new FileReader();
            reader.onloadend = () => commitEntry(reader.result);
            reader.readAsDataURL(file);
        } else { commitEntry(""); }
    }

    function commitEntry(img) {
        logs.push({
            id: Date.now(),
            date: document.getElementById('date').value,
            acc: document.getElementById('accSelect').value,
            type: document.getElementById('type').value,
            desc: document.getElementById('desc').value || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
            amt: parseFloat(document.getElementById('amt').value),
            slip: img
        });
        document.getElementById('amt').value = ''; document.getElementById('desc').value = '';
        document.getElementById('slipInput').value = ''; saveAndUI();
    }

    function saveAndUI() {
        localStorage.setItem('FIN_V4_ACCS', JSON.stringify(accounts));
        localStorage.setItem('FIN_V4_LOGS', JSON.stringify(logs));
        updateUI();
    }

    function updateUI() {
        document.getElementById('accSelect').innerHTML = accounts.map(a => `<option value="${a}">${a}</option>`).join('');
        document.getElementById('accBadges').innerHTML = accounts.map(a => `<span class="badge">${a} <b onclick="removeAccount('${a}')" style="color:var(--danger); cursor:pointer;">√ó</b></span>`).join(' ');

        logs.sort((a,b) => new Date(a.date) - new Date(b.date));
        let bals = {}; accounts.forEach(a => bals[a] = 0);
        let processed = logs.map(l => {
            if(bals[l.acc] === undefined) bals[l.acc] = 0;
            l.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? bals[l.acc] += l.amt : bals[l.acc] -= l.amt;
            return { ...l, runningBal: bals[l.acc] };
        });

        document.getElementById('accCards').innerHTML = accounts.map(a => `<div class="acc-card"><h4>${a}</h4><h2>${(bals[a] || 0).toLocaleString()} ‡∏ø</h2></div>`).join('');

        const fMonth = document.getElementById('filterMonth').value;
        const tbody = document.getElementById('dataTable');
        tbody.innerHTML = '';
        [...processed].reverse().filter(l => l.date.startsWith(fMonth)).forEach(l => {
            tbody.innerHTML += `<tr id="row-${l.id}">
                <td>${l.date}</td><td><span style="font-size:12px; font-weight:bold;">${l.acc}</span></td>
                <td class="txt-${l.type}">${l.type}</td><td>${l.desc}</td>
                <td class="txt-${l.type}">${l.amt.toLocaleString()}</td>
                <td>${l.slip ? `<img src="${l.slip}" style="width:40px;height:40px;object-fit:cover;border-radius:5px;" onclick="showImg('${l.slip}')">` : '-'}</td>
                <td style="font-weight:bold">${l.runningBal.toLocaleString()}</td>
                <td><button onclick="deleteEntry(${l.id})" style="background:#cbd5e0; border:none; padding:8px; border-radius:8px;">üóëÔ∏è</button></td>
            </tr>`;
        });
    }

    function deleteEntry(id) { if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) { logs = logs.filter(l => l.id !== id); saveAndUI(); } }
    function showImg(src) { document.getElementById('lightImg').src = src; document.getElementById('lightbox').style.display = 'flex'; }

    function exportExcelFull() {
        const selM = document.getElementById('filterMonth').value;
        const wb = XLSX.utils.book_new();
        logs.sort((a,b) => new Date(a.date) - new Date(b.date));
        let bals = {}; accounts.forEach(a => bals[a] = 0);
        const processed = logs.map(l => {
            l.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? bals[l.acc] += l.amt : bals[l.acc] -= l.amt;
            return { ...l, runningBal: bals[l.acc] };
        });
        accounts.forEach(acc => {
            const accLogs = processed.filter(l => l.acc === acc && l.date.startsWith(selM));
            if(accLogs.length === 0) return;
            const rows = [
                ["‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: " + acc + " (" + selM + ")"],
                ["‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°", accLogs.filter(x=>x.type==='‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö').reduce((s,x)=>s+x.amt,0)],
                ["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°", accLogs.filter(x=>x.type==='‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢').reduce((s,x)=>s+x.amt,0)],
                ["‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", accLogs.filter(x=>x.type==='‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö').reduce((s,x)=>s+x.amt,0) - accLogs.filter(x=>x.type==='‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢').reduce((s,x)=>s+x.amt,0)],
                [],
                ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", "‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∞‡∏™‡∏°"]
            ];
            accLogs.forEach(l => rows.push([l.date, l.type, l.desc, l.amt, l.runningBal]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), acc.substring(0,30));
        });
        XLSX.writeFile(wb, `Finance_Master_${selM}.xlsx`);
    }

    updateUI();
</script>
</body>
</html>
