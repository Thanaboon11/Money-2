<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∞</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --success: #22c55e; --danger: #ef4444; --bg: #f8fafc; --dark: #1e293b; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        .container { max-width: 1100px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 25px; }
        .input-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 14px; font-weight: 600; color: #64748b; }
        input, select { padding: 12px; border-radius: 12px; border: 1.5px solid #e2e8f0; font-size: 16px; outline: none; }
        .btn-save { grid-column: 1 / -1; background: var(--primary); color: white; padding: 16px; border-radius: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .acc-grid { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; }
        .acc-card { min-width: 180px; background: linear-gradient(135deg, #6366f1, #4338ca); color: white; padding: 20px; border-radius: 18px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 850px; }
        td { background: white; padding: 12px; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
        .txt-‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö { color: var(--success); font-weight: bold; }
        .txt-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ { color: var(--danger); font-weight: bold; }
        .import-box { margin-bottom: 20px; padding: 20px; background: #eff6ff; border-radius: 15px; border: 2px dashed #bfdbfe; }
        .edit-mode { background: #fffbeb !important; }
        button.action-btn { border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; color: white; font-size: 14px; margin-left: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center; color: var(--primary); margin: 25px 0;">üí∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∞</h2>

    <div class="card">
        <h3>üè¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <input type="text" id="newAcc" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£" style="flex:2">
            <button onclick="addAccount()" style="flex:1; background:var(--dark); color:white; border-radius:12px; border:none; font-weight:bold;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
        </div>
        <div id="accBadges" style="margin-top:15px; display:flex; gap:8px; flex-wrap:wrap;"></div>
    </div>

    <div id="accCards" class="acc-grid"></div>

    <div class="card">
        <h3>üìù ‡∏•‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
        <div class="input-form">
            <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="date"></div>
            <div class="form-group"><label>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><select id="accSelect"></select></div>
            <div class="form-group"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="type"><option value="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option><option value="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" selected>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option></select></div>
            <div class="form-group"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="desc" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£"></div>
            <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input type="number" id="amt" placeholder="0.00"></div>
            <div class="form-group"><label>‡∏™‡∏•‡∏¥‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="file" id="slipInput" accept="image/*"></div>
            <button class="btn-save" onclick="saveData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ üí∞</button>
        </div>
    </div>

    <div class="card">
        <div class="import-box">
            <label style="font-weight:bold; color:#1e40af;">üìÇ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏° (Excel) ‡∏°‡∏≤‡∏à‡∏î‡∏ï‡πà‡∏≠:</label>
            <input type="file" accept=".xlsx" onchange="importFromExcel(this)" style="margin-top:10px; width:100%;">
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
            <input type="month" id="filterMonth" onchange="updateUI()" style="width:auto;">
            <button onclick="exportExcelFull()" style="background:var(--success); color:white; border:none; padding:12px 20px; border-radius:12px; font-weight:bold;">üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
        </div>

        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let accounts = JSON.parse(localStorage.getItem('FIN_V5_ACCS')) || ['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ', '‡∏Å‡∏™‡∏¥‡∏Å‡∏£ üè¶'];
    let logs = JSON.parse(localStorage.getItem('FIN_V5_LOGS')) || [];

    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);

    function addAccount() {
        let name = document.getElementById('newAcc').value.trim();
        if(name && !accounts.includes(name)) { accounts.push(name); document.getElementById('newAcc').value = ''; saveAndUI(); }
    }

    function removeAccount(name) {
        if(confirm(`‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${name}?`)) { accounts = accounts.filter(a => a !== name); saveAndUI(); }
    }

    function saveData() {
        let amt = parseFloat(document.getElementById('amt').value) || 0;
        let file = document.getElementById('slipInput').files[0];
        if(amt <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
        if (file) {
            let reader = new FileReader();
            reader.onloadend = () => commitEntry(reader.result);
            reader.readAsDataURL(file);
        } else { commitEntry(""); }
    }

    function commitEntry(img) {
        logs.push({ id: Date.now(), date: document.getElementById('date').value, acc: document.getElementById('accSelect').value, type: document.getElementById('type').value, desc: document.getElementById('desc').value || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", amt: parseFloat(document.getElementById('amt').value), slip: img });
        document.getElementById('amt').value = ''; document.getElementById('desc').value = ''; document.getElementById('slipInput').value = ''; saveAndUI();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    function startEdit(id) {
        const row = document.getElementById(`row-${id}`);
        const item = logs.find(l => l.id === id);
        let accOpts = accounts.map(a => `<option value="${a}" ${a===item.acc?'selected':''}>${a}</option>`).join('');
        row.className = 'edit-mode';
        row.innerHTML = `<td colspan="7"><div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap:8px; padding:10px;">
            <input type="date" id="ed-date-${id}" value="${item.date}">
            <select id="ed-acc-${id}">${accOpts}</select>
            <select id="ed-type-${id}"><option value="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" ${item.type==='‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'?'selected':''}>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option><option value="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" ${item.type==='‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'?'selected':''}>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option></select>
            <input type="text" id="ed-desc-${id}" value="${item.desc}">
            <input type="number" id="ed-amt-${id}" value="${item.amt}">
            <button onclick="confirmEdit(${id})" style="background:var(--success); color:white; border:none; border-radius:5px;">‡∏ï‡∏Å‡∏•‡∏á</button>
            <button onclick="updateUI()" style="background:#888; color:white; border:none; border-radius:5px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div></td>`;
    }

    function confirmEdit(id) {
        const item = logs.find(l => l.id === id);
        item.date = document.getElementById(`ed-date-${id}`).value;
        item.acc = document.getElementById(`ed-acc-${id}`).value;
        item.type = document.getElementById(`ed-type-${id}`).value;
        item.desc = document.getElementById(`ed-desc-${id}`).value;
        item.amt = parseFloat(document.getElementById(`ed-amt-${id}`).value) || 0;
        saveAndUI();
    }

    function saveAndUI() { localStorage.setItem('FIN_V5_ACCS', JSON.stringify(accounts)); localStorage.setItem('FIN_V5_LOGS', JSON.stringify(logs)); updateUI(); }

    function updateUI() {
        document.getElementById('accSelect').innerHTML = accounts.map(a => `<option value="${a}">${a}</option>`).join('');
        document.getElementById('accBadges').innerHTML = accounts.map(a => `<span style="background:#eee; padding:5px 10px; border-radius:8px; font-size:13px;">${a} <b onclick="removeAccount('${a}')" style="color:red; cursor:pointer;">√ó</b></span>`).join(' ');
        
        logs.sort((a,b) => new Date(a.date) - new Date(b.date));
        let bals = {}; accounts.forEach(a => bals[a] = 0);
        let processed = logs.map(l => {
            if(bals[l.acc] === undefined) bals[l.acc] = 0;
            l.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? bals[l.acc] += l.amt : bals[l.acc] -= l.amt;
            return { ...l, runningBal: bals[l.acc] };
        });

        document.getElementById('accCards').innerHTML = accounts.map(a => `<div class="acc-card"><h4>${a}</h4><h2>${(bals[a] || 0).toLocaleString()} ‡∏ø</h2></div>`).join('');
        const fMonth = document.getElementById('filterMonth').value;
        const tbody = document.getElementById('dataTable');
        tbody.innerHTML = '';
        [...processed].reverse().filter(l => l.date.startsWith(fMonth)).forEach(l => {
            tbody.innerHTML += `<tr id="row-${l.id}">
                <td>${l.date}</td><td>${l.acc}</td><td class="txt-${l.type}">${l.type}</td>
                <td>${l.desc}</td><td class="txt-${l.type}">${l.amt.toLocaleString()}</td>
                <td style="font-weight:bold">${l.runningBal.toLocaleString()}</td>
                <td>
                    <button class="action-btn" onclick="startEdit(${l.id})" style="background:orange;">‚úèÔ∏è</button>
                    <button class="action-btn" onclick="deleteEntry(${l.id})" style="background:#888;">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
    }

    function importFromExcel(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            let newLogs = [];
            workbook.SheetNames.forEach(sheetName => {
                const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {range: 5});
                sheetData.forEach(row => {
                    if(row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"]) {
                        newLogs.push({ id: Date.now() + Math.random(), date: row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"], acc: sheetName, type: row["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"], desc: row["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"], amt: parseFloat(row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"]) || 0, slip: "" });
                    }
                });
            });
            if(newLogs.length > 0 && confirm(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${newLogs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ß‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) { logs = [...logs, ...newLogs]; saveAndUI(); }
        };
        reader.readAsArrayBuffer(file);
    }

    function deleteEntry(id) { if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) { logs = logs.filter(l => l.id !== id); saveAndUI(); } }

    function exportExcelFull() {
        const selM = document.getElementById('filterMonth').value;
        const wb = XLSX.utils.book_new();
        logs.sort((a,b) => new Date(a.date) - new Date(b.date));
        let bals = {}; accounts.forEach(a => bals[a] = 0);
        const processed = logs.map(l => { l.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? bals[l.acc] += l.amt : bals[l.acc] -= l.amt; return { ...l, runningBal: bals[l.acc] }; });
        accounts.forEach(acc => {
            const accLogs = processed.filter(l => l.acc === acc && l.date.startsWith(selM));
            if(accLogs.length === 0) return;
            const rows = [ ["‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: " + acc + " (" + selM + ")"], ["‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°", accLogs.filter(x=>x.type==='‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö').reduce((s,x)=>s+x.amt,0)], ["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°", accLogs.filter(x=>x.type==='‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢').reduce((s,x)=>s+x.amt,0)], ["‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠", accLogs.filter(x=>x.type==='‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö').reduce((s,x)=>s+x.amt,0) - accLogs.filter(x=>x.type==='‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢').reduce((s,x)=>s+x.amt,0)], [], ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", "‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∞‡∏™‡∏°"] ];
            accLogs.forEach(l => rows.push([l.date, l.type, l.desc, l.amt, l.runningBal]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), acc.substring(0,30));
        });
        XLSX.writeFile(wb, `Finance_Master_${selM}.xlsx`);
    }

    updateUI();
</script>
</body>
</html>
